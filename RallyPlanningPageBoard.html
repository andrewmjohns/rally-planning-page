<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- Copyright (c) 2010 Rally Software Development Corp. All rights reserved -->
<html>
<head>
   <title>App Example: Card Board Custom Column Renderer</title>
   <meta name="Name" content="App Example: Card Board Custom Column Renderer" />
   <meta name="Vendor" content="Rally Software" />

   <script type="text/javascript" src="https://rally1.rallydev.com/apps/1.32/sdk.js"></script>
   <script type="text/javascript" src="CardBoardColumnRenderer.js"></script>
   <script type="text/javascript" src="CardBoardCardRenderer.js"></script>
   <script type="text/javascript" src="utility.js"></script>

   <script type="text/javascript">
		var RallyDataSource;
	    var today = toISOString(new Date());
		var Backlog;
	    var IterationToPlan;
	    var cardboardConfig;
	    var IterationReady, BacklogReady = false;
		
		function onLoad() {
			RallyDataSource = new rally.sdk.data.RallyDataSource(	'__WORKSPACE_OID__',
																	'__PROJECT_OID__',
																	'__PROJECT_SCOPING_UP__',
																	'__PROJECT_SCOPING_DOWN__');
			RallyDataSource.setApiVersion("1.41");

			RallyDataSource.find( {
	  		   		key: 'iterations',
	        		type: 'Iteration',
         			fetch: 'Name',
	     			query: '(StartDate >= "' + today + '")',
	     			pagesize: 1
				}, function (results) {
					IterationToPlan = results.iterations[0];
					dataReady("iteration");
				}
			);
			RallyDataSource.findAll( [ {
		    	    key: 'stories',
		        	type: 'HierarchicalRequirement',
		    	    fetch: 'Name,FormattedID,Owner,ObjectID,PlanEstimate,ScheduleState,Rank,Iteration,Children,Tags,Discussion',
		        	query: '((ScheduleState != "Accepted") AND (DirectChildrenCount = 0))'
				}, {
					key: 'defects',
		    	    type: 'defects',
		    	    fetch: 'Name,FormattedID,Owner,ObjectID,PlanEstimate,ScheduleState,Rank,Iteration,Tags,Discussion',
			        query: '(ScheduleState != "Accepted")'
				} ],
				function (results) {
		    		//combine the stories and defects into one list sort them by rank
        			Backlog = results.stories.concat(results.defects);
			        Backlog.sort(function sortFunc(a, b){return a.Rank - b.Rank});
        			dataReady("backlog");
			    }
			);

		   	cardboardConfig = {
				types: ["Defects", "HierarchicalRequirement"],
				attribute: "Iteration",
				fetch:"Name,FormattedID,Owner,ObjectID,PlanEstimate,Tags,Discussion",
				columnRenderer:VelocityColumnRenderer,
				cardRenderer:FullCardRenderer
			};
		}

		function dataReady(dataType){
			if(dataType == "iteration") {
				var columns = {};
				columns[""]={displayValue:"Backlog",wipLimit:Infinity};
				columns[IterationToPlan._ref]={displayValue:IterationToPlan.Name,wipLimit:Infinity};

				cardboardConfig["columns"] = columns;
				IterationReady = true;
				
			} else if(dataType == "backlog") {
				cardboardConfig["items"] = Backlog;
				BacklogReady = true;
			}
			if(IterationReady && BacklogReady) {
				displayBoard();
			}
		}
	
		function displayBoard(){
	    	var cardboard = new rally.sdk.ui.CardBoard(cardboardConfig, RallyDataSource);
    	   	cardboard.display(dojo.body());
	     }

     rally.addOnLoad(onLoad);

   </script>
   <style type="text/css">
     .cardboard .infinitySymbol {
       font-size: 16px;
       position: relative;
       top: 2px;
     }
     .overCapacity .columnHeader {
       color: #FC5350;
     }

     .overCapacity .columnContent, .dojoDndMove .columnContent.noDrop.dojoDndContainerOver {
     {
       background-color: #F9E2E1;
     }

     .cardboard .columnHeader {
       height: 35px;
     }

     .cardboard .capacityDisplay {
       font-size: 12px;
       line-height: 20px;
     }
   </style>
</head>
<body>
</body>
</html>